<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dify Workflow App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Basic scroll behavior for the chat log */
        #chat-log {
            height: 70vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="config-screen" class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full">
        <h2 class="text-3xl font-bold text-center mb-6 text-indigo-700">Workflow Config</h2>
        <div class="space-y-4">
            <div>
                <label for="apiUrlInput" class="block text-sm font-medium text-gray-700 mb-1">Dify API Endpoint (e.g., /v1/workflows/run)</label>
                <input type="text" id="apiUrlInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500" placeholder="https://api.dify.ai/v1/workflows/{workflow_id}/run">
            </div>
            <div>
                <label for="apiKeyInput" class="block text-sm font-medium text-gray-700 mb-1">Dify API Key</label>
                <input type="password" id="apiKeyInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500" placeholder="app-xxxxxxxxxxxxxxxxxx">
            </div>
            <button id="startChatButton" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors font-semibold mt-4">Start Workflow</button>
        </div>
    </div>
    
    <div id="chat-screen" class="hidden bg-white rounded-xl shadow-2xl max-w-2xl w-full flex flex-col h-[90vh]">
        <header class="p-4 border-b bg-indigo-50 rounded-t-xl">
            <h1 class="text-xl font-bold text-indigo-800">Dify Workflow Runner</h1>
        </header>

        <div id="chat-log" class="p-4 flex-grow space-y-4">
            </div>

        <div class="p-4 border-t">
            <div class="flex gap-2">
                <input type="text" id="userInput" placeholder="Enter your query or input..." class="flex-grow px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500" disabled>
                <button id="sendButton" class="bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700 transition-colors disabled:opacity-50" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                </button>
            </div>
            <p id="statusMessage" class="text-sm text-gray-500 mt-2 hidden">Running workflow...</p>
        </div>
    </div>

    <script>
        // --- Configuration Variables ---
        let API_KEY = '';
        let API_URL = '';

        // --- DOM Elements ---
        const configScreen = document.getElementById('config-screen');
        const chatScreen = document.getElementById('chat-screen');
        const startChatButton = document.getElementById('startChatButton');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const apiUrlInput = document.getElementById('apiUrlInput');
        const chatLog = document.getElementById('chat-log');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const statusMessage = document.getElementById('statusMessage');

        // --- Functions ---

        /**
         * Renders a message bubble to the chat log.
         * @param {string} content - The message text.
         * @param {string} role - 'user' or 'assistant'.
         */
        function renderMessage(content, role) {
            const isUser = role === 'user';
            const msgDiv = document.createElement('div');
            msgDiv.className = `flex gap-3 ${isUser ? 'justify-end' : 'justify-start'}`;

            const iconHtml = isUser 
                ? '<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>'
                : '<div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot"><path d="M12 11V3"/><path d="M12 21a2 2 0 0 0 2-2 2 2 0 0 0-2-2 2 2 0 0 0-2 2 2 2 0 0 0 2 2Z"/><path d="M12 19v-4"/><path d="M8 11V3"/><path d="M16 11V3"/><path d="M8 21a2 2 0 0 0 2-2 2 2 0 0 0-2-2 2 2 0 0 0-2 2 2 2 0 0 0 2 2Z"/><path d="M16 21a2 2 0 0 0 2-2 2 2 0 0 0-2-2 2 2 0 0 0-2 2 2 2 0 0 0 2 2Z"/></svg></div>';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = `max-w-[80%] rounded-2xl px-4 py-3 whitespace-pre-wrap ${
                isUser ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-800'
            }`;
            contentDiv.innerHTML = content;

            if (!isUser) msgDiv.innerHTML += iconHtml;
            msgDiv.appendChild(contentDiv);
            if (isUser) msgDiv.innerHTML += iconHtml;

            chatLog.appendChild(msgDiv);
            chatLog.scrollTop = chatLog.scrollHeight; // Auto-scroll
        }

        /**
         * Handles the workflow submission.
         */
        async function runWorkflow() {
            const query = userInput.value.trim();
            if (!query) return;

            // 1. Display user message
            renderMessage(query, 'user');
            userInput.value = '';

            // 2. Disable input and show status
            userInput.disabled = true;
            sendButton.disabled = true;
            statusMessage.textContent = 'Running workflow...';
            statusMessage.classList.remove('hidden');

            try {
                // 3. Make API call
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        // Your inputs must match what the Dify workflow expects.
                        // For a simple single-input workflow, the input name might be 'query'.
                        inputs: {
                            query: query 
                        },
                        response_mode: 'blocking', // Wait for the full result
                        user: 'html-app-user-' + Date.now()
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                
                // 4. Extract and display result (check Dify's specific JSON structure)
                let assistantMessage = 'Workflow ran successfully.';
                
                if (data.status === 'succeeded' && data.workflow_run.outputs) {
                    // This is a common structure for Dify workflow results
                    // You might need to adjust 'text' to the specific output key of your workflow
                    assistantMessage = JSON.stringify(data.workflow_run.outputs, null, 2) || 'No visible output.';
                } else if (data.answer) {
                    // For chat-messages style APIs
                    assistantMessage = data.answer;
                } else {
                    assistantMessage = 'Workflow finished, but output format was unexpected. See console for full response.';
                    console.log('Full Dify response:', data);
                }
                
                renderMessage(assistantMessage, 'assistant');

            } catch (error) {
                console.error('Error:', error);
                renderMessage('Sorry, an error occurred. Check the console and ensure your API URL/Key are correct.', 'assistant');
            } finally {
                // 5. Re-enable input
                userInput.disabled = false;
                sendButton.disabled = false;
                statusMessage.classList.add('hidden');
                userInput.focus();
            }
        }

        // --- Event Listeners ---

        // Configuration setup
        startChatButton.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            const url = apiUrlInput.value.trim();
            if (key && url) {
                API_KEY = key;
                API_URL = url;
                configScreen.classList.add('hidden');
                chatScreen.classList.remove('hidden');
                userInput.disabled = false;
                sendButton.disabled = false;
                renderMessage("Configuration loaded. Enter your prompt to run the Dify workflow.", 'assistant');
                userInput.focus();
            } else {
                alert('Please enter both the API URL and API Key.');
            }
        });

        // Workflow execution listeners
        sendButton.addEventListener('click', runWorkflow);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !userInput.disabled) {
                e.preventDefault();
                runWorkflow();
            }
        });

    </script>
</body>
</html>
