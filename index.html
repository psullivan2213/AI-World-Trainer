<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dify Workflow App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Basic scroll behavior for the chat log */
        #chat-log {
            height: 70vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="config-screen" class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full">
        <h2 class="text-3xl font-bold text-center mb-6 text-indigo-700">Workflow Config</h2>
        <div class="space-y-4">
            <div>
                <label for="apiUrlInput" class="block text-sm font-medium text-gray-700 mb-1">Dify API Endpoint (e.g., /v1/workflows/run)</label>
                <input type="text" id="apiUrlInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500" placeholder="https://api.dify.ai/v1/workflows/{workflow_id}/run">
            </div>
            <div>
                <label for="apiKeyInput" class="block text-sm font-medium text-gray-700 mb-1">Dify API Key</label>
                <input type="password" id="apiKeyInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500" placeholder="app-xxxxxxxxxxxxxxxxxx">
            </div>
            
            <div id="configStatus" class="text-center text-sm p-2 rounded hidden"></div>

            <button id="startChatButton" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors font-semibold mt-4">
                Test & Start Workflow
            </button>
        </div>
    </div>
    
    <div id="chat-screen" class="hidden bg-white rounded-xl shadow-2xl max-w-2xl w-full flex flex-col h-[90vh]">
        <header class="p-4 border-b bg-indigo-50 rounded-t-xl flex justify-between items-center">
            <h1 class="text-xl font-bold text-indigo-800">Dify Workflow Runner</h1>
            <button id="backButton" class="text-sm text-gray-600 hover:text-gray-800 bg-white py-1 px-3 border rounded-lg transition-colors">
                Change API Config
            </button>
        </header>

        <div id="chat-log" class="p-4 flex-grow space-y-4">
            </div>

        <div class="p-4 border-t">
            <div class="flex gap-2">
                <input type="text" id="userInput" placeholder="Enter your query or input..." class="flex-grow px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500" disabled>
                <button id="sendButton" class="bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700 transition-colors disabled:opacity-50" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                </button>
            </div>
            <p id="statusMessage" class="text-sm text-gray-500 mt-2 hidden">Running workflow...</p>
        </div>
    </div>

    <script>
        // --- Configuration Variables ---
        let API_KEY = '';
        let API_URL = '';

        // --- DOM Elements ---
        const configScreen = document.getElementById('config-screen');
        const chatScreen = document.getElementById('chat-screen');
        const startChatButton = document.getElementById('startChatButton');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const apiUrlInput = document.getElementById('apiUrlInput');
        const configStatus = document.getElementById('configStatus'); // New element
        const chatLog = document.getElementById('chat-log');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const statusMessage = document.getElementById('statusMessage');
        const backButton = document.getElementById('backButton'); // New element

        // --- Utility Functions ---

        /**
         * Sets the configuration status message.
         * @param {string} message - The message to display.
         * @param {boolean} isSuccess - True for success (green), false for error (red).
         */
        function setConfigStatus(message, isSuccess) {
            configStatus.textContent = message;
            configStatus.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (isSuccess) {
                configStatus.classList.add('bg-green-100', 'text-green-700');
            } else {
                configStatus.classList.add('bg-red-100', 'text-red-700');
            }
            startChatButton.disabled = false; // Re-enable button after check
        }
        
        // ... (renderMessage, runWorkflow functions remain the same as before) ...
        
        /**
         * Renders a message bubble to the chat log.
         * @param {string} content - The message text.
         * @param {string} role - 'user' or 'assistant'.
         */
        function renderMessage(content, role) {
            const isUser = role === 'user';
            const msgDiv = document.createElement('div');
            msgDiv.className = `flex gap-3 ${isUser ? 'justify-end' : 'justify-start'}`;

            const iconHtml = isUser 
                ? '<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>'
                : '<div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot"><path d="M12 11V3"/><path d="M12 21a2 2 0 0 0 2-2 2 2 0 0 0-2-2 2 2 0 0 0-2 2 2 2 0 0 0 2 2Z"/><path d="M12 19v-4"/><path d="M8 11V3"/><path d="M16 11V3"/><path d="M8 21a2 2 0 0 0 2-2 2 2 0 0 0-2-2 2 2 0 0 0-2 2 2 2 0 0 0 2 2Z"/><path d="M16 21a2 2 0 0 0 2-2 2 2 0 0 0-2-2 2 2 0 0 0-2 2 2 2 0 0 0 2 2Z"/></svg></div>';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = `max-w-[80%] rounded-2xl px-4 py-3 whitespace-pre-wrap ${
                isUser ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-800'
            }`;
            contentDiv.innerHTML = content;

            if (!isUser) msgDiv.innerHTML += iconHtml;
            msgDiv.appendChild(contentDiv);
            if (isUser) msgDiv.innerHTML += iconHtml;

            chatLog.appendChild(msgDiv);
            chatLog.scrollTop = chatLog.scrollHeight; // Auto-scroll
        }
        
        /**
         * Handles the workflow submission. (Unchanged)
         */
        async function runWorkflow() {
            const query = userInput.value.trim();
            if (!query) return;

            // 1. Display user message
            renderMessage(query, 'user');
            userInput.value = '';

            // 2. Disable input and show status
            userInput.disabled = true;
            sendButton.disabled = true;
            statusMessage.textContent = 'Running workflow...';
            statusMessage.classList.remove('hidden');

            try {
                // 3. Make API call
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        inputs: {
                            query: query 
                        },
                        response_mode: 'blocking',
                        user: 'html-app-user-' + Date.now()
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                
                // 4. Extract and display result 
                let assistantMessage = 'Workflow ran successfully.';
                
                if (data.status === 'succeeded' && data.workflow_run.outputs) {
                    assistantMessage = JSON.stringify(data.workflow_run.outputs, null, 2) || 'No visible output.';
                } else if (data.answer) {
                    assistantMessage = data.answer;
                } else {
                    assistantMessage = 'Workflow finished, but output format was unexpected. See console for full response.';
                    console.log('Full Dify response:', data);
                }
                
                renderMessage(assistantMessage, 'assistant');

            } catch (error) {
                console.error('Error:', error);
                renderMessage('Sorry, an error occurred. Check the console and ensure your API URL/Key are correct.', 'assistant');
            } finally {
                // 5. Re-enable input
                userInput.disabled = false;
                sendButton.disabled = false;
                statusMessage.classList.add('hidden');
                userInput.focus();
            }
        }
        
        // --- Debugger Function ---
        
        /**
         * Tests the configuration by attempting a blank run/message call.
         */
        async function testApiConfiguration() {
            const key = apiKeyInput.value.trim();
            const url = apiUrlInput.value.trim();
            startChatButton.disabled = true;

            if (!key || !url) {
                setConfigStatus('Please enter both the API URL and API Key.', false);
                return;
            }
            
            setConfigStatus('Testing API connection...', false); // Set temporary status

            try {
                // Use a generic Dify API call for testing (like the run endpoint with empty inputs)
                const testResponse = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        inputs: {
                            query: "Test" // Send a trivial input
                        },
                        response_mode: 'blocking',
                        user: 'html-app-test-' + Date.now()
                    })
                });

                if (testResponse.ok || testResponse.status === 400) {
                    // 200 OK or 400 Bad Request (which means the API key/URL is likely correct, 
                    // but the inputs are wrong, which is acceptable for a configuration test).
                    setConfigStatus('Configuration successful! Ready to run your workflow.', true);
                    
                    // Proceed to chat screen after a short delay
                    setTimeout(() => {
                        API_KEY = key;
                        API_URL = url;
                        chatLog.innerHTML = ''; // Clear old messages
                        configScreen.classList.add('hidden');
                        chatScreen.classList.remove('hidden');
                        userInput.disabled = false;
                        sendButton.disabled = false;
                        renderMessage("Configuration loaded. Enter your prompt to run the Dify workflow.", 'assistant');
                        userInput.focus();
                    }, 1500);

                } else if (testResponse.status === 401) {
                    setConfigStatus('Error 401: Unauthorized. Check your API Key.', false);
                } else if (testResponse.status === 404) {
                    setConfigStatus('Error 404: Not Found. Check your API URL/Endpoint path.', false);
                } else {
                    setConfigStatus(`Error ${testResponse.status}: API check failed. Check console for details.`, false);
                }

            } catch (error) {
                console.error('API Test Error:', error);
                setConfigStatus('Connection failed. Check your network or if the URL is accessible (e.g., CORS error).', false);
            }
        }

        // --- Event Listeners ---

        // Configuration setup button now runs the debugger
        startChatButton.addEventListener('click', testApiConfiguration);

        // Back button to return to config screen
        backButton.addEventListener('click', () => {
            configScreen.classList.remove('hidden');
            chatScreen.classList.add('hidden');
            setConfigStatus('Enter new configuration or click "Test & Start" again.', true);
        });

        // Workflow execution listeners (Unchanged)
        sendButton.addEventListener('click', runWorkflow);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !userInput.disabled) {
                e.preventDefault();
                runWorkflow();
            }
        });
    </script>
</body>
</html>
